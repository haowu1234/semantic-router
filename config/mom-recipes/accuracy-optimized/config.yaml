# Accuracy-Optimized MoM Recipe
# Maximum accuracy through confidence-based model escalation and domain-specialized routing
#
# Usage: vllm-sr serve --config config/mom-recipes/accuracy-optimized/config.yaml

# Response API Configuration
response_api:
  enabled: true
  store_backend: "memory"
  ttl_seconds: 86400
  max_responses: 1000

# Semantic Cache - High threshold for accuracy-focused caching
semantic_cache:
  enabled: true
  backend_type: "memory"
  similarity_threshold: 0.92  # High threshold - only cache near-identical queries
  max_entries: 5000
  ttl_seconds: 3600
  eviction_policy: "fifo"
  use_hnsw: true
  hnsw_m: 16
  hnsw_ef_construction: 200
  embedding_model: "qwen3"  # High quality embeddings for accurate matching

# Tools Configuration
tools:
  enabled: true
  top_k: 3
  similarity_threshold: 0.2
  tools_db_path: "config/tools_db.json"
  fallback_to_empty: true

# Prompt Guard - Enabled for safety
prompt_guard:
  enabled: true
  use_modernbert: false
  model_id: "models/mom-jailbreak-classifier"
  threshold: 0.7
  use_cpu: true
  jailbreak_mapping_path: "models/mom-jailbreak-classifier/label_mapping.json"

# Classifier Configuration
classifier:
  category_model:
    model_id: "models/mom-domain-classifier"
    threshold: 0.6
    use_cpu: true
    category_mapping_path: "models/mom-domain-classifier/category_mapping.json"
  pii_model:
    model_id: "models/mom-pii-classifier"
    use_modernbert: false
    threshold: 0.9
    use_cpu: true
  pii_mapping_path: "models/mom-pii-classifier/label_mapping.json"

# Hallucination Mitigation - Enabled for fact-heavy domains
hallucination_mitigation:
  enabled: true
  fact_check_model:
    model_id: "models/mom-halugate-sentinel"
    threshold: 0.6
    use_cpu: true
  hallucination_model:
    model_id: "models/mom-halugate-detector"
    threshold: 0.8
    use_cpu: true
  nli_model:
    model_id: "models/mom-halugate-explainer"
    threshold: 0.9
    use_cpu: true

# vLLM Endpoints Configuration
# Configure multiple endpoints for different model sizes
vllm_endpoints:
  - name: "endpoint-small"
    address: "127.0.0.1"
    port: 8001
    weight: 1
  - name: "endpoint-medium"
    address: "127.0.0.1"
    port: 8002
    weight: 1
  - name: "endpoint-large"
    address: "127.0.0.1"
    port: 8003
    weight: 1

# Model Configuration
# Three-tier model setup for accuracy optimization
model_config:
  "qwen3-small":
    reasoning_family: "qwen3"
    preferred_endpoints: ["endpoint-small"]
  "qwen3-medium":
    reasoning_family: "qwen3"
    preferred_endpoints: ["endpoint-medium"]
  "qwen3-large":
    reasoning_family: "qwen3"
    preferred_endpoints: ["endpoint-large"]

# Categories - Domain metadata for routing
categories:
  - name: business
    description: "Business and management related queries"
    mmlu_categories: ["business"]
  - name: law
    description: "Legal questions and law-related topics"
    mmlu_categories: ["law"]
  - name: psychology
    description: "Psychology and mental health topics"
    mmlu_categories: ["psychology"]
  - name: biology
    description: "Biology and life sciences questions"
    mmlu_categories: ["biology"]
  - name: chemistry
    description: "Chemistry and chemical sciences questions"
    mmlu_categories: ["chemistry"]
  - name: history
    description: "Historical questions and cultural topics"
    mmlu_categories: ["history"]
  - name: other
    description: "General knowledge and miscellaneous topics"
    mmlu_categories: ["other"]
  - name: health
    description: "Health and medical information queries"
    mmlu_categories: ["health"]
  - name: economics
    description: "Economics and financial topics"
    mmlu_categories: ["economics"]
  - name: math
    description: "Mathematics and quantitative reasoning"
    mmlu_categories: ["math"]
  - name: physics
    description: "Physics and physical sciences"
    mmlu_categories: ["physics"]
  - name: computer_science
    description: "Computer science and programming"
    mmlu_categories: ["computer_science"]
  - name: philosophy
    description: "Philosophy and ethical questions"
    mmlu_categories: ["philosophy"]
  - name: engineering
    description: "Engineering and technical problem-solving"
    mmlu_categories: ["engineering"]

# Routing Strategy
strategy: "priority"

# Decisions - Accuracy-optimized routing logic
# STEM domains (math, physics, chemistry, engineering) use large model with reasoning
# Other academic domains use medium model
# General queries use small model with potential escalation

decisions:
  # STEM Domains - Large model with reasoning enabled
  - name: "math_decision"
    description: "Mathematics - requires deep reasoning"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "math"
    modelRefs:
      - model: "qwen3-large"
        use_reasoning: true
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are an expert mathematician. Provide rigorous, step-by-step proofs and solutions. Show all work clearly, explain your reasoning at each step, and verify your answers. Use formal mathematical notation when appropriate."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []
      - type: "hallucination"
        configuration:
          enabled: true

  - name: "physics_decision"
    description: "Physics - requires deep reasoning"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "physics"
    modelRefs:
      - model: "qwen3-large"
        use_reasoning: true
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are an expert physicist. Provide detailed explanations with mathematical derivations when appropriate. Consider both classical and modern physics principles. Verify dimensional consistency and physical reasonableness of your answers."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []
      - type: "hallucination"
        configuration:
          enabled: true

  - name: "chemistry_decision"
    description: "Chemistry - requires deep reasoning"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "chemistry"
    modelRefs:
      - model: "qwen3-large"
        use_reasoning: true
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are an expert chemist. Provide detailed explanations of chemical reactions, molecular structures, and laboratory techniques. Include reaction mechanisms, electron configurations, and thermodynamic considerations when relevant."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []
      - type: "hallucination"
        configuration:
          enabled: true

  - name: "engineering_decision"
    description: "Engineering - requires deep reasoning"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "engineering"
    modelRefs:
      - model: "qwen3-large"
        use_reasoning: true
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are an expert engineer with knowledge across multiple disciplines. Apply engineering principles, design methodologies, and problem-solving approaches. Consider safety, efficiency, sustainability, and cost-effectiveness. Provide calculations and technical specifications when appropriate."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  # Academic Domains - Medium model without reasoning
  - name: "biology_decision"
    description: "Biology and life sciences"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "biology"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a biology expert with comprehensive knowledge spanning molecular biology, genetics, cell biology, ecology, evolution, anatomy, physiology, and biotechnology. Explain biological concepts with scientific accuracy and provide examples from current research."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []
      - type: "hallucination"
        configuration:
          enabled: true

  - name: "computer_science_decision"
    description: "Computer science and programming"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "computer_science"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a computer science expert with knowledge of algorithms, data structures, programming languages, and software engineering. Provide clear, practical solutions with code examples when helpful. Analyze time and space complexity when relevant."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  - name: "economics_decision"
    description: "Economics and financial topics"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "economics"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are an economics expert with deep understanding of microeconomics, macroeconomics, econometrics, financial markets, and economic theory. Analyze economic phenomena using established principles and provide data-driven insights."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  - name: "health_decision"
    description: "Health and medical information"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "health"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a health and medical information expert. Provide accurate, evidence-based health information while emphasizing that your responses are for educational purposes only and should never replace professional medical advice, diagnosis, or treatment."
      - type: "semantic-cache"
        configuration:
          enabled: true
          similarity_threshold: 0.95
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []
      - type: "hallucination"
        configuration:
          enabled: true

  - name: "law_decision"
    description: "Legal questions and law-related topics"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "law"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a knowledgeable legal expert with comprehensive understanding of legal principles, case law, statutory interpretation, and legal procedures. Provide accurate legal information while clearly stating that your responses do not constitute legal advice."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  - name: "psychology_decision"
    description: "Psychology and mental health topics"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "psychology"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a psychology expert with deep knowledge of cognitive processes, behavioral patterns, mental health, and therapeutic approaches. Provide evidence-based insights grounded in psychological research and theory."
      - type: "semantic-cache"
        configuration:
          enabled: true
          similarity_threshold: 0.92
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  - name: "philosophy_decision"
    description: "Philosophy and ethical questions"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "philosophy"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a philosophy expert with comprehensive knowledge of philosophical traditions, ethical theories, logic, metaphysics, epistemology, and political philosophy. Engage with complex questions by presenting multiple perspectives and analyzing arguments rigorously."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  - name: "history_decision"
    description: "Historical questions and cultural topics"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "history"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a historian with expertise across different time periods and cultures. Provide accurate historical context, analyze primary sources, and present multiple historical perspectives when relevant."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []
      - type: "hallucination"
        configuration:
          enabled: true

  - name: "business_decision"
    description: "Business and management queries"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "business"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a senior business consultant with expertise in corporate strategy, operations management, financial analysis, marketing, and organizational development. Provide practical, actionable business advice backed by proven methodologies."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

  # Fallback - General queries
  - name: "general_decision"
    description: "General knowledge and miscellaneous topics"
    priority: 50
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "other"
    modelRefs:
      - model: "qwen3-medium"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a helpful and knowledgeable assistant. Provide accurate, helpful responses across a wide range of topics. Be thorough and informative."
      - type: "semantic-cache"
        configuration:
          enabled: true
          similarity_threshold: 0.85
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

# Default model for unmatched queries
default_model: qwen3-medium

# Reasoning family configurations
reasoning_families:
  qwen3:
    type: "chat_template_kwargs"
    parameter: "enable_thinking"

# Global default reasoning effort level
default_reasoning_effort: high

# Router Configuration for confidence-based escalation
router:
  high_confidence_threshold: 0.8
  low_confidence_threshold: 0.6
  low_latency_threshold_ms: 5000  # Relaxed latency for accuracy
  lora_baseline_score: 0.8
  traditional_baseline_score: 0.7
  success_confidence_threshold: 0.8
  default_confidence_threshold: 0.95
  default_max_latency_ms: 10000

# API Configuration
api:
  batch_classification:
    max_batch_size: 50
    concurrency_threshold: 5
    max_concurrency: 8
    metrics:
      enabled: true
      detailed_goroutine_tracking: true
      sample_rate: 1.0

# Embedding Models Configuration
embedding_models:
  qwen3_model_path: "models/mom-embedding-pro"
  use_cpu: true

# Observability Configuration
observability:
  metrics:
    enabled: true
  tracing:
    enabled: true
    provider: "opentelemetry"
    exporter:
      type: "otlp"
      endpoint: "jaeger:4317"
      insecure: true
    sampling:
      type: "always_on"
      rate: 1.0
    resource:
      service_name: "vllm-semantic-router-accuracy"
      service_version: "v1.0.0"
      deployment_environment: "production"
